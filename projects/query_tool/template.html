<!DOCTYPE html>
<html>
<head>
<title>AIND DocDB Query Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        .container {
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            height: auto;
            min-height: 40px;
            max-height: 500px;
            font-family: monospace;
            font-size: 14px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
            overflow-y: auto;
            line-height: 1.5;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .results {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: monospace;
            white-space: pre;
            min-height: 100px;
            overflow-x: auto;
        }
        .error {
            background-color: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }
        .example {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }
        .loading {
            display: none;
            color: #666;
            font-style: italic;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .tab {
            padding: 8px 16px;
            background-color: #e0e0e0;
            border: none;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background-color: #4CAF50;
            color: white;
        }
        .result-view {
            display: none;
        }
        .result-view.active {
            display: block;
        }
        .tree-node, .tree-leaf {
            font-family: monospace;
        }
        .tree-children {
            padding-left: 32px;
        }
        details summary {
            color: #000;
            cursor: pointer;
        }
        .tree-leaf {
            color: #000;
        }
        .tree-leaf .value {
            color: #10b981;
        }
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .db-selector {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            gap: 30px;
            align-items: center;
        }
        .db-selector-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .db-selector-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        .button-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .share-btn {
            background-color: #2196F3;
        }
        .share-btn:hover {
            background-color: #0b7dda;
        }
        .share-link-container {
            display: none;
            background-color: #e8f5e9;
            padding: 12px;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #4CAF50;
        }
        .share-link-container.show {
            display: block;
        }
        .share-link {
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            background-color: white;
            padding: 8px;
            border-radius: 3px;
            margin: 8px 0;
            border: 1px solid #ccc;
        }
        .copy-btn {
            background-color: #4CAF50;
            padding: 6px 12px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>AIND DocDB Query Tool</h1>
    <p>Query the AIND metadata database (data_assets collection)</p>
    
    <div class="db-selector">
        <div class="db-selector-group">
            <strong>Environment:</strong>
            <label><input type="radio" name="environment" value="prod" checked> Production</label>
            <label><input type="radio" name="environment" value="dev"> Development</label>
        </div>
        <div class="db-selector-group">
            <strong>Database:</strong>
            <label><input type="radio" name="dbversion" value="v1" checked> V1 (metadata_index)</label>
            <label><input type="radio" name="dbversion" value="v2"> V2 (metadata_index_v2)</label>
        </div>
    </div>
    
    <div class="container">
        <h3>Enter MongoDB Query or Aggregation Pipeline</h3>
        <div class="example">
            <strong>Examples:</strong><br>
            <em>Aggregation pipeline (array surrounded by square brackets):</em><br>
            <code>[{"$match": {"data_description.project_name": "Cognitive flexibility in patch foraging"}}, {"$limit": 2}]</code><br><br>
            <em>Simple query:</em><br>
            <code>{"name": "behavior_754574_2024-11-22_09-39-39"}</code>
        </div>
        <p style="font-size: 12px; margin-top: 4px; margin-bottom: 8px;">Press Enter to run the query. Use Shift+Enter to add a new line.</p>
        <textarea id="query" placeholder='Enter an aggregation pipeline (JSON array) or a single document. Arrays run as-is; single documents are treated as {"$match": doc} with an automatic limit. JSON5 is accepted (unquoted keys, single quotes).'>[{"$match": {"data_description.project_name": "Cognitive flexibility in patch foraging"}}, {"$limit": 2}]</textarea>
    </div>
    
    <div class="button-group">
        <button id="runBtn">Run Query</button>
        <button id="shareBtn" class="share-btn">Generate Share Link</button>
        <span class="loading" id="loading">Running query...</span>
    </div>
    
    <div class="share-link-container" id="shareLinkContainer">
        <strong>Shareable link:</strong>
        <div class="share-link" id="shareLink"></div>
        <button class="copy-btn" id="copyBtn">Copy to Clipboard</button>
    </div>
    
    <div class="container" style="margin-top: 30px;">
        <h3>Results</h3>
        <div class="tabs">
            <button class="tab active" data-view="tree">Tree</button>
            <button class="tab" data-view="json">JSON</button>
        </div>
        <div class="controls">
            <label><input type="checkbox" id="expand-all"> Expand all</label>
        </div>
        <div id="tree-view" class="results result-view active">No results yet. Run a query above.</div>
        <div id="json-view" class="results result-view">No results yet. Run a query above.</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
        var treeView = document.getElementById('tree-view');
        var jsonView = document.getElementById('json-view');
        var runBtn = document.getElementById('runBtn');
        var loading = document.getElementById('loading');
        var queryInput = document.getElementById('query');
        var expandAllToggle = document.getElementById('expand-all');
        var shareBtn = document.getElementById('shareBtn');
        var shareLinkContainer = document.getElementById('shareLinkContainer');
        var shareLink = document.getElementById('shareLink');
        var copyBtn = document.getElementById('copyBtn');
        var lastResults = null;
        var lastCount = null;
        var lastDefaultLimitApplied = false;
        var lastDefaultLimit = null;
        
        // Parse URL parameters on page load
        function getUrlParams() {
            var params = {};
            var search = window.location.search.substring(1);
            if (search) {
                var pairs = search.split('&');
                for (var i = 0; i < pairs.length; i++) {
                    var pair = pairs[i].split('=');
                    params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
                }
            }
            return params;
        }
        
        // Load state from URL if present
        var urlParams = getUrlParams();
        var hasUrlParams = false;
        if (urlParams.query) {
            queryInput.value = urlParams.query;
            hasUrlParams = true;
        }
        if (urlParams.env) {
            var envRadio = document.querySelector('input[name="environment"][value="' + urlParams.env + '"]');
            if (envRadio) {
                envRadio.checked = true;
                hasUrlParams = true;
            }
        }
        if (urlParams.db) {
            var dbRadio = document.querySelector('input[name="dbversion"][value="' + urlParams.db + '"]');
            if (dbRadio) {
                dbRadio.checked = true;
                hasUrlParams = true;
            }
        }

        function switchTab(viewName) {
        var tabs = document.querySelectorAll('.tab');
        for (var i = 0; i < tabs.length; i++) {
            tabs[i].classList.toggle('active', tabs[i].dataset.view === viewName);
        }
        var views = document.querySelectorAll('.result-view');
        for (var j = 0; j < views.length; j++) {
            views[j].classList.toggle('active', views[j].id === viewName + '-view');
        }
        }

        function isObject(value) {
            return value !== null && typeof value === 'object' && !Array.isArray(value);
        }

        function formatScalar(value) {
            if (typeof value === 'string') return '"' + value + '"';
            if (value === null) return 'null';
            return String(value);
        }

        function buildTreeNode(value, label, depth) {
            if (typeof depth === 'undefined') depth = 0;
            if (Array.isArray(value) || isObject(value)) {
                var details = document.createElement('details');
                // Auto-expand first level (depth 0), otherwise respect expand-all toggle
                details.open = depth === 0 || expandAllToggle.checked;
                var summary = document.createElement('summary');
                summary.textContent = label;
                details.appendChild(summary);

                var children = document.createElement('div');
                children.className = 'tree-children';

                if (Array.isArray(value)) {
                    for (var idx = 0; idx < value.length; idx++) {
                        children.appendChild(buildTreeNode(value[idx], '[' + idx + ']', depth + 1));
                    }
                } else {
                    var entries = Object.entries(value);
                    for (var i = 0; i < entries.length; i++) {
                        var k = entries[i][0];
                        var v = entries[i][1];
                        children.appendChild(buildTreeNode(v, k, depth + 1));
                    }
                }

                details.appendChild(children);
                return details;
            }

            var leaf = document.createElement('div');
            leaf.className = 'tree-leaf';
            var labelSpan = document.createElement('span');
            labelSpan.textContent = label + ': ';
            var valueSpan = document.createElement('span');
            valueSpan.className = 'value';
            valueSpan.textContent = formatScalar(value);
            leaf.appendChild(labelSpan);
            leaf.appendChild(valueSpan);
            return leaf;
        }

        function renderJsonTree(data, count, defaultLimitApplied, defaultLimit) {
            treeView.innerHTML = '';
            if (data === null || data === undefined) {
                treeView.textContent = 'No results.';
                return;
            }
            // Add count at the top
            if (typeof count === 'number') {
                var countDiv = document.createElement('div');
                countDiv.style.marginBottom = '12px';
                countDiv.style.fontWeight = 'bold';
                var docWord = count === 1 ? 'document' : 'documents';
                countDiv.textContent = count + ' ' + docWord + ' returned';
                treeView.appendChild(countDiv);
                
                // Add note if default limit was applied AND we hit the limit
                if (defaultLimitApplied && defaultLimit && count === defaultLimit) {
                    var noteDiv = document.createElement('div');
                    noteDiv.style.marginBottom = '12px';
                    noteDiv.style.fontSize = '13px';
                    noteDiv.style.color = '#666';
                    noteDiv.textContent = 'Note: Default limit of ' + defaultLimit + ' applied. To see more results, run an aggregation pipeline with a custom $limit stage.';
                    treeView.appendChild(noteDiv);
                }
            }
            var container = document.createElement('div');
            if (Array.isArray(data)) {
                if (data.length === 0) {
                    container.textContent = '[] (no documents)';
                } else {
                    for (var idx = 0; idx < data.length; idx++) {
                        container.appendChild(buildTreeNode(data[idx], 'doc ' + idx));
                    }
                }
            } else if (isObject(data)) {
                container.appendChild(buildTreeNode(data, 'root'));
            } else {
                container.textContent = formatScalar(data);
            }
            treeView.appendChild(container);
        }

        function renderRawJson(data, count, defaultLimitApplied, defaultLimit) {
            if (data === null || data === undefined) {
                jsonView.textContent = 'No results.';
                return;
            }
            var jsonText = JSON.stringify(data, null, 2);
            var countText = '';
            if (typeof count === 'number') {
                var docWord = count === 1 ? 'document' : 'documents';
                countText = count + ' ' + docWord + ' returned\n';
                if (defaultLimitApplied && defaultLimit && count === defaultLimit) {
                    countText = countText + 'Note: Default limit of ' + defaultLimit + ' applied. To see more results, run an aggregation pipeline with a custom $limit stage.\n';
                }
                countText = countText + '\n';
            }
            jsonView.textContent = countText + jsonText;
        }

        function runQuery() {
            var query = queryInput.value;
            var environment = document.querySelector('input[name="environment"]:checked').value;
            var dbversion = document.querySelector('input[name="dbversion"]:checked').value;

            treeView.textContent = '';
            jsonView.textContent = '';
            treeView.classList.remove('error');
            jsonView.classList.remove('error');

            runBtn.disabled = true;
            loading.style.display = 'inline';

            fetch('/query', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    pipeline: query,
                    environment: environment,
                    dbversion: dbversion
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.error) {
                    treeView.textContent = 'Error: ' + data.error;
                    treeView.classList.add('error');
                    jsonView.textContent = 'Error: ' + data.error;
                    jsonView.classList.add('error');
                } else {
                    lastResults = data.results;
                    lastCount = data.count;
                    lastDefaultLimitApplied = data.default_limit_applied || false;
                    lastDefaultLimit = data.default_limit || null;
                    renderJsonTree(lastResults, lastCount, lastDefaultLimitApplied, lastDefaultLimit);
                    renderRawJson(lastResults, lastCount, lastDefaultLimitApplied, lastDefaultLimit);
                }
            })
            .catch(function(e) {
                treeView.textContent = 'Error running query: ' + e.message;
                treeView.classList.add('error');
                jsonView.textContent = 'Error running query: ' + e.message;
                jsonView.classList.add('error');
            })
            .finally(function() {
                runBtn.disabled = false;
                loading.style.display = 'none';
            });
        }

        var tabButtons = document.querySelectorAll('.tab');
        for (var i = 0; i < tabButtons.length; i++) {
            (function(tab) {
                tab.addEventListener('click', function(e) { switchTab(tab.dataset.view); });
            })(tabButtons[i]);
        }

        runBtn.addEventListener('click', runQuery);

        queryInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                runQuery();
            }
        });

        queryInput.addEventListener('focus', function(e) {
            e.target.select();
        });

        function autoResizeTextarea() {
            // Reset height to get accurate scrollHeight
            queryInput.style.height = '40px';
            var maxHeight = 500; // matches max-height in CSS
            var scrollHeight = queryInput.scrollHeight;
            queryInput.style.height = Math.min(scrollHeight, maxHeight) + 'px';
        }

        queryInput.addEventListener('input', autoResizeTextarea);
        queryInput.addEventListener('paste', function() {
            setTimeout(autoResizeTextarea, 10);
        });
        // Resize on initial load
        setTimeout(autoResizeTextarea, 100);

        expandAllToggle.addEventListener('change', function() {
            if (lastResults !== null) {
                renderJsonTree(lastResults, lastCount, lastDefaultLimitApplied, lastDefaultLimit);
            }
        });
        
        // Generate share link
        shareBtn.addEventListener('click', function() {
            var query = queryInput.value;
            var environment = document.querySelector('input[name="environment"]:checked').value;
            var dbversion = document.querySelector('input[name="dbversion"]:checked').value;
            
            var baseUrl = window.location.origin + window.location.pathname;
            var params = [];
            params.push('query=' + encodeURIComponent(query));
            params.push('env=' + encodeURIComponent(environment));
            params.push('db=' + encodeURIComponent(dbversion));
            
            var fullUrl = baseUrl + '?' + params.join('&');
            shareLink.textContent = fullUrl;
            shareLinkContainer.classList.add('show');
        });
        
        // Copy share link to clipboard
        copyBtn.addEventListener('click', function() {
            var linkText = shareLink.textContent;
            
            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(linkText).then(function() {
                    var originalText = copyBtn.textContent;
                    copyBtn.textContent = 'Copied!';
                    setTimeout(function() {
                        copyBtn.textContent = originalText;
                    }, 2000);
                }).catch(function(err) {
                    // Fall back to manual selection method
                    fallbackCopy(linkText);
                });
            } else {
                // Fall back for older browsers
                fallbackCopy(linkText);
            }
        });
        
        function fallbackCopy(text) {
            // Create a temporary textarea
            var textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                var successful = document.execCommand('copy');
                if (successful) {
                    var originalText = copyBtn.textContent;
                    copyBtn.textContent = 'Copied!';
                    setTimeout(function() {
                        copyBtn.textContent = originalText;
                    }, 2000);
                } else {
                    alert('Please manually select and copy the link');
                }
            } catch (err) {
                alert('Copy failed. Please select and copy manually.');
            }
            
            document.body.removeChild(textarea);
        }
        }); // end DOMContentLoaded
    </script>
</body>
</html>
